<!DOCTYPE html>
    <!--
 | Generated by Apache Maven Doxia Site Renderer 1.11.1 at 23 Sep 2024 
 | Rendered using Bloomreach Forge Maven Skin 3.2.1 based on Apache Maven Fluido Skin
-->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                  <meta name="Date-Revision-yyyymmdd" content="20240923" />
              <meta http-equiv="Content-Language" content="en" />
      <title>Bloomreach Forge Page Flow &#x2013; Bloomreach Page Flow Module</title>
  <link rel="stylesheet" href="./css/forge-maven-skin-syntaxhighlighter-3.2.1.min.css"/>
  <link rel="stylesheet" href="./css/forge-maven-skin-3.2.1.min.css"/>
  <link rel="stylesheet" href="./css/site.css" />
  <link rel="stylesheet" href="./css/print.css" media="print" />
  <link rel="icon" type="image/png" href="./images/skin/logo_64.png" sizes="64x64">

  
  <script type="text/javascript" src="./js/forge-maven-skin-syntaxhighlighter-3.2.1.min.js"></script>
  <script type="text/javascript" src="./js/forge-maven-skin-3.2.1.min.js"></script>

            <style>.github-fork-ribbon:before { background-color: green; }</style>
</head>
<body class="topBarDisabled">
              <a target="_blank" class="github-fork-ribbon right" href="https://github.com/bloomreach-forge/page-flow"
     data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a>
          <div class="container-fluid">
  <div id="banner">
    <div id="logo">
                        <a href="https://bloomreach-forge.github.io">
        <img src="./images/skin/logo.png" alt="Bloomreach Forge Logo" />
      </a>
    </div>
    <div class="pull-left">              <div id="bannerLeft">    <h1>Page Flow</h1>
    </div>
              </div>
    <div class="pull-right"></div>
    <div class="clear"><hr/></div>
  </div>

  <div id="breadcrumbs">
                            <div class="links">
      <a href="https://xmdocumentation.bloomreach.com">xmdocumentation.bloomreach.com</a>
      <a href="https://github.com/bloomreach-forge">github.com/bloomreach-forge</a>
    </div>
    <ul class="breadcrumb">
    
  <li id="publishDate">published: 23 Sep 2024  
  </li>
  
        
            </ul>
    <div class="clear"><hr/></div>
  </div>
<div class="row-fluid">
  <div id="leftColumn" class="span2">
    <div class="well sidebar-nav">
    
    <ul class="nav nav-list">
            <li>  <a href="index.html" title="Home">  <span class="none"></span>  Home</a>  </li>
        <li>  <a href="demoproject.html" title="Demo Project">  <span class="none"></span>  Demo Project</a>  </li>
        <li>  <a href="install.html" title="Installation">  <span class="none"></span>  Installation</a>  </li>
        <li>  <a href="configure.html" title="Configuration">  <span class="none"></span>  Configuration</a>  </li>
        <li class="active">  <a href="#"><span class="none"></span>Developer's How-to</a>
  </li>
        <li>  <a href="apidocs/index.html" title="JavaDocs">  <span class="none"></span>  JavaDocs</a>  </li>
        <li>  <a href="release-notes.html" title="Release Notes">  <span class="none"></span>  Release Notes</a>  </li>
        </ul>
    
          <hr />
      <div id="poweredBy">
                <div class="clear"></div>
                <div class="clear"></div>
                <div class="clear"></div>
                <div class="clear"></div>
              <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">  <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />  </a>
          </div>
    </div>
  </div>
  <div id="bodyColumn"  class="span10" >
    
  

    <section>
<h2><a name="Developer.27s_How-to"></a>Developer's How-to</h2>

      <section>
<h3><a name="Introduction"></a>Introduction</h3>
        
<p>
          <b>Page Flow Module</b> simplifies Page State definitions, Page State Transitions based on Events, Error Handling per Page State and metadata handlings in web applications.
        </p>
        
<p>
          Normally, each Page State is mapped to an HST Page with an unique URI path info. You may have multiple, different <code>HstComponent</code>s in each HST Page like you do in normal HST-2 web application development.
        </p>
        
<p>
          As <b>Page Flow Module</b> aims to cover visitors' interactions across (multi-step) HST Pages, it is not interested in providing too tightly coupled framework with MVC form/action handling, unlike Spring Web Flow for example.
        </p>
        
<p>
          In that sense, it is the <code>HstComponent</code>s responsibility to send an event to trigger Page State Transitions. <b>Page Flow Module</b> would not send events or trigger transitions on a Page Flow instance automatically based on <code>HstComponent</code>'s status changes.
        </p>
        
<p>
          Also, it is not an interest of <b>Page Flow Module</b> to provide a <i>bridging</i> solution between <code>HstComponent</code> and other web flow control frameworks such as Spring Web Flow because that kind of approaches would simply force the flow interactions to stay in the specific <code>HstComponent</code> only, causing inflexibility in page/component compositions and significant limitations in Relevance personalization and Experiment (A/B Testing).
        </p>
      </section>

      <section>
<h3><a name="Page_Flow_Definition"></a>Page Flow Definition</h3>
        
<p>First of all, you need to create and publish a <b>Page Flow Definition</b> which is applied to a Microsite campaign channel or selected sitemap items, like the following example document in CMS:</p>
        <img src="images/demoflowdef1.png" alt="Demo Page Flow Definition 1" />

        <section>
<h4><a name="Fields_of_Page_Flow_Definition"></a>Fields of Page Flow Definition</h4>
        
<table border="0" class="table table-striped">
          <thead>
            
<tr class="a">
              
<th width="200px">Field name</th>
              
<th>Description</th>
            </tr>
          </thead>
          <tbody>
            
<tr class="b">
              
<td align="left">Name</td>
              
<td>Human readable name of Page Flow Definition</td>
            </tr>
            
<tr class="a">
              
<td align="left">Flow ID</td>
              
<td>Unique Identifier of Page Flow Definition, used by system</td>
            </tr>
            
<tr class="b">
              
<td align="left">Description</td>
              
<td>Informative description of Page Flow Definition</td>
            </tr>
            
<tr class="a">
              
<td align="left">Page States</td>
              
<td>Page State Compounds field</td>
            </tr>
            
<tr class="b">
              
<td align="left">Event Definitions</td>
              
<td>Event Definitions field</td>
            </tr>
            
<tr class="a">
              
<td align="left">Global Page Transitions</td>
              
<td>Globally applied Page Transitions on each Page State</td>
            </tr>
          </tbody>
        </table>

        </section><section>
<h4><a name="Fields_of_Each_Page_State_Compound"></a>Fields of Each Page State Compound</h4>
        
<table border="0" class="table table-striped">
          <thead>
            
<tr class="a">
              
<th width="200px">Field name</th>
              
<th>Description</th>
            </tr>
          </thead>
          <tbody>
            
<tr class="b">
              
<td align="left">Name</td>
              
<td>Human readable name of Page State Definition</td>
            </tr>
            
<tr class="a">
              
<td align="left">Page State ID</td>
              
<td>Unique Identifier in a Page Flow Definition, used by system</td>
            </tr>
            
<tr class="b">
              
<td align="left">Path</td>
              
<td>Logical (URI) Path Info to be interpreted by application</td>
            </tr>
            
<tr class="a">
              
<td align="left">Metadata</td>
              
<td>Extra custom metadata, which can be used by application</td>
            </tr>
            
<tr class="b">
              
<td align="left">Page Transitions</td>
              
<td>Page Transition Compounds field</td>
            </tr>
          </tbody>
        </table>

        </section><section>
<h4><a name="Fields_of_Each_Page_Transition_Compound"></a>Fields of Each Page Transition Compound</h4>
        
<table border="0" class="table table-striped">
          <thead>
            
<tr class="a">
              
<th width="200px">Field name</th>
              
<th>Description</th>
            </tr>
          </thead>
          <tbody>
            
<tr class="b">
              
<td align="left">Event</td>
              
<td>The source Event, to be selected from <b>Event Definitions</b></td>
            </tr>
            
<tr class="a">
              
<td align="left">Target</td>
              
<td>The target Page State to transition, to be selected from defined <b>Page State</b>s</td>
            </tr>
          </tbody>
        </table>

        </section><section>
<h4><a name="Fields_of_Each_Event_Definition_Compound"></a>Fields of Each Event Definition Compound</h4>
        
<table border="0" class="table table-striped">
          <thead>
            
<tr class="a">
              
<th width="200px">Field name</th>
              
<th>Description</th>
            </tr>
          </thead>
          <tbody>
            
<tr class="b">
              
<td align="left">Name</td>
              
<td>The unique identifier of an event in Page Flow Definition</td>
            </tr>
            
<tr class="a">
              
<td align="left">Value</td>
              
<td>The human readable name of an event</td>
            </tr>
          </tbody>
        </table>

        
<p>
          The above <b>Page Flow Definition</b> document defines all the page states, events and transitions in the document editor. It shows all the definitions including <i>Page State</i>s, <i>Event</i>s and <i>Page Transition</i>s in flat lists. But, due to the <b>Page Transition</b> fields, each of which consists of a source <b>Event</b> and a target <b>Page State</b>, the whole <b>Page Flow</b> can represents the following <i>Finite State Machine</i> diagram:
        </p>
        <img src="images/demoflowfsm1.png" alt="Demo Finite State Machine 1" />
      </section></section>

      <section>
<h3><a name="Page_State_Definition_and_HST_Page"></a>Page State Definition and HST Page</h3>
        
<p>
          As shown above, each <b>Page State</b> has <b>Path</b> field which is normally mapped to the URI path of an <b>HST Page</b>. So, while a <b>Page Flow</b> instance for a visitor is alive, the visitor should be passing along a specific <b>Page State</b> based on events and transitions. By default in HST-2 web application, each <b>Page State</b> is represented by an <b>HST Page</b>, which means that the request from a visitor hits an <b>HST SiteMap Item</b> and the associated <b>HST Page</b> is being rendered for the <b>Page State</b>.
        </p>
        
<p>
          This default behavior in HST-2 web application has the following advantages:
        </p>

        
<ul>
          
<li>You can separate each step of the visitor's interactions into a separate <b>HST Page</b>, so it is more flexible when composing each page with different components/templates and personalization.</li>
          
<li>You can even set a specific step page URI as an Experiment goal easily.</li>
          
<li>In an <b>HST Page</b>, one of <code>HstComponent</code>s may process an action to retrieve the current <code>PageFlow</code> to send an event to trigger an automatic transition. Once a transition occurs by the event, the default <b>Page Flow HstSiteMapItemHandler</b> will redirect the page to the next step automatically. Therefore, <code>HstComponent</code>s do not have to handle any physical navigation/redirection handling by themselves any more as it is handled by <b>Page Flow Module</b>.</li>
        </ul>

        
<p><i>Note</i>: It is possible to customize the default HST-2 based Page Flow Control and interpret the logical <b>Path</b> information of each <b>Page State</b> in application-specific ways.</p>
      </section>

      <section>
<h3><a name="Events_and_Page_State_Transitions"></a>Events and Page State Transitions</h3>
        
<p>Let's take a look at the <code>CampaignQuoteComponent.java</code>, as an example, shown in the first step landing page in the demo project:</p>

        
<div class="brush: java">
          
<div class="source"><pre>
          public class CampaignQuoteComponent extends AbstractCampaignComponent {

              private static final Pattern US_ZIP_PATTERN = Pattern.compile(&quot;^\\d{5}$&quot;);

              @Override
              public void doAction(HstRequest request, HstResponse response) throws HstComponentException {
                  final String zip = StringUtils.trim(request.getParameter(&quot;zip&quot;));

                  final PageFlow pageFlow = getPageFlow();
                  final CampaignModel campaignModel = new CampaignModel();
                  campaignModel.setZip(zip);
                  pageFlow.setAttribute(CampaignConstants.DEFAULT_MODEL_NAME, campaignModel);

                  if (StringUtils.isNotEmpty(zip)) {
                      final Matcher m = US_ZIP_PATTERN.matcher(zip);

                      if (m.matches()) {
                          pageFlow.sendEvent(CampaignConstants.EVENT_START_QUOTE);
                      }
                  }
              }

          }
        </pre></div>
        </div>

        
<p><i>CampaignQuoteComponent#doAction()</i> method is invoked when a visitor clicks on <i></i>Start!<i></i> button in the first landing page, doing the following:</p>
        
<ul>
          
<li>Read the only form input, &quot;zip&quot; code.</li>
          
<li>Retrieve the current <code>PageFlow</code> instance which was resolved and provided by the <b>Page Flow Module</b> automatically.</li>
          
<li>Instantiate a new domain model object, <code>CampaignModel</code>, set the zip code and store it into <code>pageFlow</code>, so that you can retrieve the domain model object later in other <b>Page State</b>s.</li>
          
<li>Finally, if everything is okay, it sends an event named <code>CampaignConstants.EVENT_START_QUOTE</code> (which should be same as one of the event names in the <b>Page Flow Definition</b> document).</li>
          
<li>Under the hood, <b>Page Flow Module</b> process the event and make transition(s) if needed. In this example, it will be transitioned to the next step (&quot;Select a Plan&quot;) automatically.</li>
        </ul>

        
<p>In summary,</p>
        
<ul>
          
<li><code>HstComponent</code>s should not try to redirect pages in most cases, but instead it simply retrieves the currently resolved <code>PageFlow</code> and sends an event to trigger transitions.</li>
          
<li>To send an event from an <code>HstComponent</code>, invoke <code>PageFlow#sendEvent(String eventName)</code>. Then <b>Page Flow Module</b> will automatically handle the event and make transition(s) if needed, as you defined the flow in the <b>Page Flow Definition</b> document.</li>
        </ul>
      </section>

      <section>
<h3><a name="APIs_to_Get_Access_to_PageFlow_and_PageStates"></a>APIs to Get Access to PageFlow and PageStates</h3>
        
<p>You can retrieve the automatically resolved <code>PageFlow</code> instance like the following:</p>
        
<div class="brush: java">
          
<div class="source"><pre>
          protected PageFlow getPageFlow() {
              final HstRequestContext requestContext = RequestContextProvider.get();
              final PageFlowControl flowControl = PageFlowControl.getDefault(requestContext.getServletRequest());
              return flowControl.getPageFlow(requestContext.getServletRequest());
          }
        </pre></div>
        </div>

        
<p><i>HstComponent</i> code should retrieve the <code>PageFlowControl</code> by invoking <code>PageFlowControl#getDefault(HttpServletRequest)</code> first, and get the <code>PageFlow</code> throught <code>PageFlowControl#getPageFlow(HttpServletRequest)</code>.</p>

        
<p><b>Page Flow Module</b> automatically finds a <b>PageFlow</b> instance for the visitor by retrieving a stored one or instantiate a new one if it is a new visitor.</p>

        
<p>You can also retrieve all the defined <b>PageState</b> s from the <b>PageFlow</b>.</p>

        
<p>The following FreeMarker template example is from the navigation status bar at the page bottom in the demo project:</p>
        
<div class="brush: html">
          
<div class="source"><pre>
          &lt;#assign curPageState=pageFlow.pageState&gt;
          &lt;#assign curPageStateIndex=curPageState.index&gt;

          &lt;div class=&quot;text-left&quot;&gt;
            &lt;#list pageFlow.pageStates as pageState&gt;
              &lt;#if pageState.index &lt; curPageStateIndex&gt;
                &lt;span class=&quot;label label-success&quot;&gt;${pageState.name}&lt;/span&gt;
              &lt;#elseif pageState.index == curPageStateIndex&gt;
                &lt;span class=&quot;label label-primary&quot;&gt;${pageState.name}&lt;/span&gt;
              &lt;#else&gt;
                &lt;span class=&quot;label label-default&quot;&gt;${pageState.name}&lt;/span&gt;
              &lt;/#if&gt;
            &lt;/#list&gt;
          &lt;/div&gt;
        </pre></div>
        </div>

        
<p><i>PageFlow#getPageState()</i> returns the current <b>PageState</b>. <code>PageFlow#getPageStates()</code> returns a collection of all the defined <b>PageState</b> s.</p>

        
<p>For more details, see <a href="apidocs/index.html">JavaDocs</a>.</p>
      </section>

      <section>
<h3><a name="APIs_to_Store_Domain_Objects_in_Page_Flow"></a>APIs to Store Domain Objects in Page Flow</h3>
        
<p>A Page Flow for a visitor is a longer journey than simple webpage. So, you might want to store some domain specific data for the visitor's journey. e.g, multi-step application form data.</p>
        
<p>As shown above, you may use <code>PageFlow#setAttribute(String, Object)</code> to store and retrieve arbitrary objects for your application.</p>
        
<p>For more details, see <a href="apidocs/index.html">JavaDocs</a>.</p>
      </section>

      <section>
<h3><a name="APIs_for_Error_Handling_in_Page_State"></a>APIs for Error Handling in Page State</h3>
        
<p>In an <code>HstComponent</code>, you might want to store all the collected errors while processing the form and use those error objects in view templates.</p>
        
<p>To store error objects, you can use <code>PageState#addErrors(Errors)</code>, <code>PageState#getErrorsMap()</code>, etc.</p>
        
<p>For more details, see <a href="apidocs/index.html">JavaDocs</a>.</p>

        
<p>A good example for error handling <code>HstComponent</code> and FreeMarker template can be found in the following sources in the demo project:</p>
        
<ul>
          
<li>
            <a class="externalLink" href="https://github.com/bloomreach-forge/page-flow/blob/master/demo/site/src/main/java/org/onehippo/forge/pageflow/demo/campaign/components/CampaignApplicationFormComponent.java">CampaignApplicationFormComponent.java</a>
          </li>
          
<li>
            <a class="externalLink" href="https://github.com/bloomreach-forge/page-flow/blob/master/demo/repository-data/webfiles/src/main/resources/site/freemarker/campaignbase/campaign-application-form.ftl">campaign-application-form.ftl</a>
          </li>
        </ul>
      </section>
    </section>

  

    </div>
    </div>
    </div>
    <hr/>
    <footer>
    <div class="container-fluid">
      <div class="row-fluid">
          <p class="copyright">Copyright &copy;      2011&#x2013;2024
              <a href="https://www.bloomreach.com">Bloomreach</a>.
          
</p>
    </div>
            </div>
  </footer>
    </body>
</html>

